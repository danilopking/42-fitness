<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>42 Fitness</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0f1115; --card:#161922; --muted:#8b93a7; --text:#f5f7fa;
      --accent:#34d399; --accent-2:#60a5fa; --danger:#ef4444; --ring:#243041; --border:#232838;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, Arial;
      background:linear-gradient(180deg,#0d0f14, #0b1020); color:var(--text); line-height:1.5;
    }
    header{ position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background: rgba(13,16,26,.6); border-bottom:1px solid var(--border); padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.4px; }
    .logo{ width:34px; height:34px; border-radius:10px; background:#fff; color:#111; display:grid; place-items:center;
      font-weight:800; font-size:18px; box-shadow: 0 4px 24px rgba(255,255,255,.08);
    }
    .container{padding:16px; max-width:980px; margin:0 auto;}
    .grid{display:grid; gap:14px}
    .card{ background:linear-gradient(180deg, #151826, #111725); border:1px solid var(--border);
      border-radius:16px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .card h3{margin:0 0 10px 0; font-size:18px}
    .muted{color:var(--muted)} .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{ background:var(--card); color:var(--text); border:1px solid var(--border);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn.primary{ background:linear-gradient(180deg, #2b6cb0, #2563eb); border:0 }
    .btn.ghost{ background:transparent; border:1px solid var(--border) }
    .btn:active{ transform: translateY(1px) }
    .chip{padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px;}
    .tag{padding:4px 8px; border:1px solid var(--border); border-radius:8px; font-size:11px; color:#aab4ce}
    .list{display:grid; gap:10px}
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px;
      background:linear-gradient(180deg, #131828, #0f1422); border:1px solid var(--border);
    }
    input[type="checkbox"]{ width:20px; height:20px; accent-color: var(--accent) }
    .small{font-size:12px} .divider{height:1px; background:var(--border); margin:12px 0}
    .tabs{ position:fixed; bottom:0; left:0; right:0; z-index:20; background:rgba(10,12,20,.7); backdrop-filter: blur(8px);
      border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-around; padding:8px;
    }
    .tab{ text-align:center; color:#9aa3b8; font-size:12px; padding:6px 10px; border-radius:10px }
    .tab.active{ color:#fff; background:#151a28; border:1px solid var(--border) }
    main{ padding-bottom:70px }
    .ring-wrap{display:flex; align-items:center; gap:16px} .ring{ width:112px; height:112px; } .ring text{ font-weight:700; font-size:18px; fill:#e2e8f0 }
    .kpi{display:grid; gap:6px}
    .search{ display:flex; gap:8px; } .search input{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0d1220; color:#fff; }
    .pill{border-radius:999px; padding:8px 12px; border:1px solid var(--border)}
    .filterbar{ display:flex; gap:8px; overflow:auto; padding-bottom:6px } .hidden{ display:none !important } .right{ margin-left:auto }
    .metric{ display:flex; gap:10px; align-items:baseline } .metric .label{ color:#9aa3b8; font-size:12px } .metric .value{ font-weight:700 }
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:100 }
    .modal .box{ width:min(720px, 92vw); max-height:86vh; overflow:auto } .center{ text-align:center }
    @media(min-width:820px){ .grid.cols-2{ grid-template-columns: 1.2fr .8fr } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">42</div>
      <div>Fitness</div>
    </div>
    <div class="row">
      <button class="btn ghost small" id="exportBtn">Экспорт</button>
      <button class="btn ghost small" id="importBtn">Импорт</button>
      <input type="file" id="importFile" class="hidden" accept=".json" />
    </div>
  </header>

  <main id="view-today" class="container">
    <div class="grid cols-2">
      <section class="card">
        <h3>Сегодня</h3>
        <div class="ring-wrap">
          <svg viewBox="0 0 120 120" class="ring" aria-label="прогресс">
            <circle cx="60" cy="60" r="50" stroke="var(--ring)" stroke-width="12" fill="none" />
            <circle id="ringFill" cx="60" cy="60" r="50" stroke="url(#grad)" stroke-width="12" fill="none"
                    stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="0 999"/>
            <defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#60a5fa"/><stop offset="100%" stop-color="#34d399"/>
            </linearGradient></defs>
            <text id="ringText" x="60" y="64" text-anchor="middle">0%</text>
          </svg>
          <div class="kpi">
            <div class="metric"><div class="label">Упражнений</div><div class="value" id="kpiExercises">0</div></div>
            <div class="metric"><div class="label">Выполнено</div><div class="value" id="kpiDone">0</div></div>
            <div class="metric"><div class="label">Заминка</div><div class="value" id="kpiCooldown">вкл</div></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="startBtn">Начать тренировку</button>
          <button class="btn" id="toggleCooldown">Заминка: вкл</button>
          <div class="right small muted" id="todayDate"></div>
        </div>
      </section>

      <section class="card">
        <h3>Быстрый журнал</h3>
        <div class="row">
          <div class="pill"><span class="muted small">Боль 0–10:</span> <input type="number" id="painInput" min="0" max="10" step="1" style="width:64px; margin-left:6px; background:#0d1220; color:#fff; border:1px solid var(--border); border-radius:10px; padding:8px"/></div>
          <div class="pill"><span class="muted small">Сгибание (°):</span> <input type="number" id="romInput" min="0" max="160" step="1" style="width:72px; margin-left:6px; background:#0d1220; color:#fff; border:1px solid var(--border); border-radius:10px; padding:8px"/></div>
          <button class="btn" id="saveQuickLog">Сохранить</button>
        </div>
        <div class="footer-note">Записывай ROM и боль после тренировки — график на вкладке «Прогресс».</div>
      </section>
    </div>

    <section class="card">
      <h3>Комплекс на сегодня</h3>
      <div id="todayList" class="list"></div>
    </section>
  </main>

  <main id="view-plan" class="container hidden">
    <section class="card">
      <h3>План недели</h3>
      <div id="planList" class="list"></div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn" id="resetPlan">Сбросить план</button>
        <button class="btn" id="switchTemplate">Сменить шаблон недели (A/B)</button>
      </div>
      <div class="footer-note">Шаблон A: 2 бега + 1 поле. Шаблон B: 2 поля + 1 бег. Зал всегда 3 дня.</div>
    </section>
  </main>

  <main id="view-library" class="container hidden">
    <section class="card">
      <h3>Библиотека упражнений</h3>
      <div class="search"><input id="searchInput" placeholder="Поиск по названию или тегу…" /><button class="btn" id="clearSearch">Очистить</button></div>
      <div class="filterbar" style="margin-top:10px">
        <div class="chip" data-tag="разминка">разминка</div>
        <div class="chip" data-tag="зал">зал</div>
        <div class="chip" data-tag="бег">бег</div>
        <div class="chip" data-tag="поле">поле</div>
        <div class="chip" data-tag="ACL-safe">ACL-safe</div>
        <div class="chip" data-tag="кор">кор</div>
      </div>
      <div id="libraryList" class="list" style="margin-top:12px"></div>
    </section>
  </main>

  <main id="view-progress" class="container hidden">
    <section class="card">
      <h3>Прогресс колена</h3>
      <canvas id="romChart" width="900" height="280" style="width:100%; border-radius:12px; background:#0d1220; border:1px solid var(--border)"></canvas>
      <div class="row" style="margin-top:10px">
        <div class="pill">Последний замер: <b id="lastROM">–</b>°</div>
        <div class="pill">Цель: <b>140</b>°</div>
        <button class="btn" id="addRomBtn">Добавить замер</button>
      </div>
    </section>
    <section class="card">
      <h3>Журнал</h3>
      <div id="logList" class="list"></div>
    </section>
  </main>

  <main id="view-settings" class="container hidden">
    <section class="card">
      <h3>Настройки</h3>
      <div class="list">
        <div class="item"><div>Язык</div><div class="muted">Русский</div></div>
        <div class="item"><div>Тема</div><div class="muted">Тёмная</div></div>
        <div class="item"><div>О приложении</div><div class="muted">42 Fitness — зал/бег/поле, пошаговый режим, ROM-график</div></div>
      </div>
    </section>
  </main>

  <nav class="tabs" role="tablist" aria-label="Навигация по разделам">
    <button class="tab active" data-view="today">Сегодня</button>
    <button class="tab" data-view="plan">План</button>
    <button class="tab" data-view="library">Библиотека</button>
    <button class="tab" data-view="progress">Прогресс</button>
    <button class="tab" data-view="settings">Настройки</button>
  </nav>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
    }
  </script>

  <script>
    const LS = { get:k=>JSON.parse(localStorage.getItem(k) || "null"), set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };

    const EX = [
      { id:"patella-mob", name:"Двигать патель", tags:["разминка","ACL-safe","колено"], howTo:"Мягкая мобилизация надколенника 1–2 мин", youtube:null },
      { id:"bench-knee-flex", name:"Сгибание колена на скамейке", tags:["разминка","ACL-safe","колено"], howTo:"Мягко увеличиваем ROM 2–3 мин", youtube:null },
      { id:"kneeling-sit", name:"На коленях приседи (вбок/назад)", tags:["разминка","ACL-safe","колено"], howTo:"Контроль без боли 1–2 мин", youtube:null },
      { id:"bike", name:"Stationary Bike (8–12 мин)", tags:["разминка","бег","кардио"], howTo:"Низкое сопротивление", youtube:null },
      { id:"heel-slides", name:"Heel Slides", tags:["разминка","ACL-safe","колено"], howTo:"3×12 без боли", youtube:"https://www.youtube.com/watch?v=6-anByqnKp8" },
      { id:"squat-weight", name:"Squats with weight", tags:["зал","сила","колено"], howTo:"3–4×6–10, техника", youtube:"https://www.youtube.com/shorts/Ak1iHbEeeY8" },
      { id:"split-squat-bul", name:"Split Squat (Bulgarian)", tags:["зал","сила"], howTo:"3×8/нога", youtube:"https://www.youtube.com/shorts/_HukgYk7lTw" },
      { id:"bridges", name:"Hip Bridges", tags:["зал","ягодицы"], howTo:"3×12", youtube:"https://www.youtube.com/watch?v=Xp33YgPZgns" },
      { id:"hip-thrust", name:"Hip Thrusts", tags:["зал","ягодицы"], howTo:"3×10", youtube:"https://www.youtube.com/watch?v=pUdIL5x0fWg" },
      { id:"rdl", name:"Deadlifts (RDL)", tags:["зал","задняя цепь"], howTo:"3×8–10 лёгкий", youtube:"https://www.youtube.com/shorts/5rIqP63yWFg" },
      { id:"leg-press", name:"Leg Press", tags:["зал","колено"], howTo:"3×10, контроль амплитуды", youtube:"https://www.youtube.com/shorts/EotSw18oR9w" },
      { id:"calf-raises", name:"Calf Raises", tags:["зал","икры"], howTo:"3×15", youtube:"https://www.youtube.com/shorts/sNqa1ad2qIQ" },
      { id:"side-plank", name:"Side Plank (progression)", tags:["зал","кор"], howTo:"3×20–45 сек", youtube:"https://www.youtube.com/watch?v=kiVFaQAyZAE" },
      { id:"dead-bug", name:"Dead Bug", tags:["зал","кор"], howTo:"3×10/стор", youtube:"https://www.youtube.com/watch?v=jbWmbhElf3Q" },
      { id:"face-pull", name:"Face Pull (band)", tags:["зал","спина"], howTo:"3×12", youtube:"https://www.youtube.com/watch?v=0Po47vvj9g4" },
      { id:"step-ups", name:"Step-ups (низк/средн платформа)", tags:["зал","бег","баланс"], howTo:"3×8/нога", youtube:"https://www.youtube.com/shorts/AiP9Cv0gkl8" },
      { id:"lat-band-walk", name:"Lateral Band Walks", tags:["зал","баланс"], howTo:"3×10 шагов/стор", youtube:"https://www.youtube.com/shorts/HW9xLHrLhxI" },
      { id:"hop-balance", name:"Hop to Balance", tags:["зал","поле","динамика"], howTo:"3×6/направление", youtube:"https://www.youtube.com/shorts/oxi3hc_Kqe8" },
      { id:"ladder", name:"Agility Ladder", tags:["зал","поле","координация"], howTo:"3–5 паттернов", youtube:"https://www.youtube.com/shorts/p3K2u1bVsR0" },
      { id:"skater", name:"Skater Jumps", tags:["зал","поле","динамика"], howTo:"3×8/стор", youtube:"https://www.youtube.com/shorts/el_HLUDDYJs" },
      { id:"shuttle", name:"Shuttle Runs", tags:["поле","скорость"], howTo:"короткие ускорения/торможения", youtube:"https://www.youtube.com/results?search_query=Shuttle+Runs" },
      { id:"cone", name:"Cone Drills", tags:["поле","координация"], howTo:"змейка/повороты", youtube:"https://www.youtube.com/shorts/SYsoujNU34Q" },
      { id:"dyn-ham", name:"Dynamic Hamstring Stretch", tags:["заминка","мобилити"], howTo:"2×30–45 сек", youtube:"https://www.youtube.com/watch?v=GBmrncZApes" },
      { id:"calf-stretch", name:"Calf Stretch", tags:["заминка","мобилити"], howTo:"2×30 сек", youtube:"https://www.youtube.com/watch?v=mafo7o7OnFo" },
    ];

    const WEEK_A = {
      1:{ title:"Зал — сила+баланс", type:"gym", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["squat-weight","split-squat-bul","bridges","hip-thrust","rdl","leg-press","calf-raises","side-plank","dead-bug","face-pull","step-ups","lat-band-walk","hop-balance","ladder","skater"],
          cooldown:["dyn-ham","calf-stretch"]
      },
      2:{ title:"Бег/кардио + ROM", type:"run", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["step-ups","hop-balance","dyn-ham","ladder"],
          cooldown:["calf-stretch"]
      },
      3:{ title:"Зал — сила+баланс", type:"gym", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["squat-weight","split-squat-bul","bridges","hip-thrust","rdl","leg-press","calf-raises","side-plank","dead-bug","face-pull","step-ups","lat-band-walk","hop-balance","ladder","skater"],
          cooldown:["dyn-ham","calf-stretch"]
      },
      4:{ title:"Бег/кардио + ROM", type:"run", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["step-ups","hop-balance","dyn-ham","ladder"],
          cooldown:["calf-stretch"]
      },
      5:{ title:"Зал — сила+баланс", type:"gym", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["squat-weight","split-squat-bul","bridges","hip-thrust","rdl","leg-press","calf-raises","side-plank","dead-bug","face-pull","step-ups","lat-band-walk","hop-balance","ladder","skater"],
          cooldown:["dyn-ham","calf-stretch"]
      },
      6:{ title:"Поле — динамика/футбол", type:"field", warmup:["patella-mob","bench-knee-flex","kneeling-sit","heel-slides"],
          list:["shuttle","cone","skater","hop-balance","ladder"],
          cooldown:["dyn-ham","calf-stretch"]
      },
      0:{ title:"Отдых/мобилити", type:"rest", warmup:["patella-mob","bench-knee-flex","kneeling-sit"], list:[], cooldown:[] }
    };

    const WEEK_B = {
      1: WEEK_A[1],
      2:{ title:"Поле — динамика/футбол", type:"field", warmup:["patella-mob","bench-knee-flex","kneeling-sit","heel-slides"],
          list:["shuttle","cone","skater","hop-balance","ladder"], cooldown:["dyn-ham","calf-stretch"] },
      3: WEEK_A[3],
      4:{ title:"Поле — динамика/футбол", type:"field", warmup:["patella-mob","bench-knee-flex","kneeling-sit","heel-slides"],
          list:["shuttle","cone","skater","hop-balance","ladder"], cooldown:["dyn-ham","calf-stretch"] },
      5: WEEK_A[5],
      6:{ title:"Бег/кардио + ROM", type:"run", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["step-ups","hop-balance","dyn-ham","ladder"], cooldown:["calf-stretch"] },
      0: WEEK_A[0]
    };

    const db = {
      exercises: LS.get("exercises") ?? EX,
      planA: LS.get("planA") ?? WEEK_A,
      planB: LS.get("planB") ?? WEEK_B,
      planToggle: LS.get("planToggle") ?? "A",
      logs: LS.get("logs") ?? [],
      today: LS.get("today") ?? {date:null, completed:[], cooldown:true}
    };
    persist();
    function persist(){ LS.set("exercises", db.exercises); LS.set("planA", db.planA); LS.set("planB", db.planB);
      LS.set("planToggle", db.planToggle); LS.set("logs", db.logs); LS.set("today", db.today); }
    function activePlan(){ return db.planToggle==="A" ? db.planA : db.planB }

    const views = {
      today: document.getElementById("view-today"),
      plan: document.getElementById("view-plan"),
      library: document.getElementById("view-library"),
      progress: document.getElementById("view-progress"),
      settings: document.getElementById("view-settings")
    };
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(t => t.addEventListener("click", () => switchView(t.dataset.view)));
    function switchView(view){
      Object.values(views).forEach(v=>v.classList.add("hidden"));
      views[view].classList.remove("hidden");
      tabs.forEach(t => t.classList.toggle("active", t.dataset.view===view));
      if(view==="plan") renderPlan();
      if(view==="library") renderLibrary();
      if(view==="progress") { drawChart(); renderLogList(); }
      if(view==="today") renderToday();
      location.hash = `#${view}`;
    }
    if(location.hash) switchView(location.hash.slice(1)); else switchView("today");

    function DOW(){ return (new Date()).getDay(); }
    function ISO(d=new Date()){ return d.toISOString().slice(0,10); }
    function exById(id){ return db.exercises.find(x=>x.id===id) }
    function isDone(id){ return db.today.completed.includes(id) }
    function toggleDone(id){ const i=db.today.completed.indexOf(id); if(i>=0) db.today.completed.splice(i,1); else db.today.completed.push(id); persist(); renderToday(); }

    function todayModel(){
      const todayISO = ISO();
      if(db.today.date !== todayISO){ db.today = {date:todayISO, completed:[], cooldown:true}; persist(); }
      const plan = activePlan()[DOW()];
      return { date: todayISO, blockTitle: plan.title, warmup: plan.warmup.map(exById), list: plan.list.map(exById), cooldown: db.today.cooldown ? plan.cooldown.map(exById) : [] };
    }

    function renderToday(){
      const m = todayModel();
      document.getElementById("todayDate").textContent = new Date().toLocaleDateString("ru-RU", {weekday:"short", day:"2-digit", month:"2-digit"});
      const sections = [ { label:"Разминка", arr:m.warmup }, { label:m.blockTitle, arr:m.list }, { label:"Заминка", arr:m.cooldown } ];
      const total = sections.reduce((s,x)=>s+x.arr.length,0); const done = db.today.completed.length; const pct = total ? Math.round(done/total*100) : 0;
      const ring = document.getElementById("ringFill"); const dash = 2*Math.PI*50; ring.setAttribute("stroke-dasharray", `${dash*pct/100} ${dash}`);
      document.getElementById("ringText").textContent = pct + "%"; document.getElementById("kpiExercises").textContent = total; document.getElementById("kpiDone").textContent = done;
      document.getElementById("kpiCooldown").textContent = db.today.cooldown ? "вкл" : "выкл"; document.getElementById("toggleCooldown").textContent = "Заминка: " + (db.today.cooldown ? "вкл" : "выкл");

      const wrap = document.getElementById("todayList"); wrap.innerHTML="";
      for(const s of sections){
        if(!s.arr.length) continue;
        const head = document.createElement("div"); head.className="muted"; head.style.margin="6px 4px"; head.textContent = s.label; wrap.appendChild(head);
        for(const ex of s.arr){
          const item = document.createElement("div"); item.className="item";
          item.innerHTML = `<div style="display:flex; gap:10px; align-items:center;">
              <input type="checkbox" ${isDone(ex.id)?"checked":""} />
              <div>
                <div style="font-weight:700">${ex.name}</div>
                <div class="small muted">${ex.howTo}</div>
                <div class="row small">
                  ${ex.tags.slice(0,3).map(t=>`<span class="tag">${t}</span>`).join(" ")}
                  ${ex.youtube ? `<a class="btn small" href="${ex.youtube}" target="_blank" rel="noopener">Видео ▶</a>` : `<span class="small muted">без видео</span>`}
                </div>
              </div>
            </div>`;
          const cb = item.querySelector("input[type=checkbox]"); cb.addEventListener("change", ()=>toggleDone(ex.id));
          wrap.appendChild(item);
        }
        wrap.appendChild(document.createElement("div")).className="divider";
      }
    }
    document.getElementById("toggleCooldown").addEventListener("click", ()=>{ db.today.cooldown = !db.today.cooldown; persist(); renderToday(); });

    document.getElementById("saveQuickLog").addEventListener("click", ()=>{
      const rom = parseInt(document.getElementById("romInput").value || ""); 
      const pain = parseInt(document.getElementById("painInput").value || ""); 
      const entry = { date:ISO(), pain: isNaN(pain)? null : pain, rom: isNaN(rom)? null : rom, completedIds:[...db.today.completed] };
      const idx = db.logs.findIndex(l=>l.date===entry.date);
      if(idx>=0) db.logs[idx]= {...db.logs[idx], ...entry }; else db.logs.push(entry);
      persist(); alert("Сохранено ✅"); document.getElementById("romInput").value=""; document.getElementById("painInput").value=""; drawChart(); renderLogList();
    });

    function lbl(i){ return ["Вс","Пн","Вт","Ср","Чт","Пт","Сб"][i] }
    function renderPlan(){
      const plan = activePlan();
      const wrap = document.getElementById("planList"); wrap.innerHTML="";
      for(const i of [1,2,3,4,5,6,0]){
        const p = plan[i]; const row = document.createElement("div"); row.className="item";
        row.innerHTML = `<div><div style="font-weight:700">${lbl(i)} — ${p.title}</div>
          <div class="small muted">Упр.: ${p.list.length} · Разминка: ${p.warmup.length} · Заминка: ${p.cooldown.length}</div></div>
          <div class="row"><button class="btn small open">Открыть</button></div>`;
        row.querySelector(".open").addEventListener("click", ()=>openDayEditor(i));
        wrap.appendChild(row);
      }
    }
    function openDayEditor(i){
      const p = activePlan()[i];
      const d = document.createElement("div"); d.className="modal";
      d.innerHTML = `<div class="card box">
        <div class="row" style="justify-content:space-between;"><h3 style="margin:0">${lbl(i)} — ${p.title}</h3><button class="btn ghost closeM">Закрыть</button></div>
        <div class="divider"></div>
        ${["Разминка","Основные","Заминка"].map((label,idx)=>{
          const arr = idx===0 ? p.warmup : idx===1 ? p.list : p.cooldown;
          return `<div class="muted" style="margin:6px 4px">${label}</div>
            <div class="list">${arr.map(id=>{
              const ex = db.exercises.find(e=>e.id===id);
              return `<div class="item"><div><div style="font-weight:700">${ex.name}</div><div class="small muted">${ex.howTo}</div></div>
                <button class="btn small" data-del="${id}" data-idx="${idx}">Убрать</button></div>`
            }).join("")}</div>`
        }).join("")}
        <div class="divider"></div>
        <div class="row">
          <input id="addById" placeholder="Добавить упражнение по ID (например, dead-bug)" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0d1220; color:#fff"/>
          <select id="targetArea" style="background:#0d1220; color:#fff; border:1px solid var(--border); border-radius:10px; padding:8px">
            <option value="1">Основные</option><option value="0">Разминка</option><option value="2">Заминка</option>
          </select>
          <button class="btn" id="addBtn">Добавить</button>
        </div>
      </div>`;
      document.body.appendChild(d);
      d.querySelector(".closeM").addEventListener("click", ()=>d.remove());
      d.querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click", ()=>{
        const arr = parseInt(b.dataset.idx)===0 ? p.warmup : parseInt(b.dataset.idx)===1 ? p.list : p.cooldown;
        const idx = arr.indexOf(b.dataset.del); if(idx>=0) arr.splice(idx,1); persist(); d.remove(); renderPlan();
      }));
      d.querySelector("#addBtn").addEventListener("click", ()=>{
        const id = d.querySelector("#addById").value.trim(); const tgt = parseInt(d.querySelector("#targetArea").value);
        if(!db.exercises.find(e=>e.id===id)){ alert("Нет упражнения с таким ID"); return; }
        const arr = tgt===0 ? p.warmup : tgt===1 ? p.list : p.cooldown; arr.push(id); persist(); d.remove(); renderPlan();
      });
    }
    document.getElementById("resetPlan").addEventListener("click", ()=>{
      if(confirm("Вернуть исходные шаблоны A/B?")){
        LS.set("planA", WEEK_A); LS.set("planB", WEEK_B);
        db.planA=WEEK_A; db.planB=WEEK_B; persist(); renderPlan();
      }
    });
    document.getElementById("switchTemplate").addEventListener("click", ()=>{
      db.planToggle = db.planToggle==="A" ? "B":"A"; persist(); renderPlan(); renderToday(); alert("Текущий шаблон: Неделя "+db.planToggle);
    });

    function drawChart(){
      const cv = document.getElementById("romChart"); const ctx = cv.getContext("2d");
      ctx.clearRect(0,0,cv.width,cv.height);
      const P = { left:50, right:20, top:20, bottom:40 }; const W = cv.width - P.left - P.right; const H = cv.height - P.top - P.bottom;
      ctx.strokeStyle = "#2a3348"; ctx.strokeRect(P.left, P.top, W, H);
      for(let i=0;i<=5;i++){ const y=P.top+(H/5)*i; ctx.beginPath(); ctx.moveTo(P.left,y); ctx.lineTo(P.left+W,y); ctx.strokeStyle="#1f2a40"; ctx.stroke(); }
      const data = [...db.logs].filter(l=>typeof l.rom==="number").sort((a,b)=>a.date.localeCompare(b.date));
      const roms = data.map(d=>d.rom); const dates = data.map(d=>d.date);
      document.getElementById("lastROM").textContent = roms.length ? roms[roms.length-1] : "–"; if(!data.length) return;
      const minROM = Math.min(90, Math.min(...roms)); const maxROM = Math.max(140, Math.max(...roms));
      const x=i=> P.left + (W/(data.length-1||1))*i; const y=v=> P.top + H - ((v-minROM)/(maxROM-minROM||1))*H;
      ctx.beginPath(); data.forEach((d,i)=>{ if(i===0) ctx.moveTo(x(i),y(d.rom)); else ctx.lineTo(x(i),y(d.rom)); }); ctx.strokeStyle="#60a5fa"; ctx.lineWidth=2; ctx.stroke();
      ctx.fillStyle="#34d399"; data.forEach((d,i)=>{ ctx.beginPath(); ctx.arc(x(i),y(d.rom),3,0,Math.PI*2); ctx.fill(); });
      ctx.fillStyle="#9aa3b8"; ctx.font="12px system-ui"; ctx.fillText(`${minROM}°`, 8, y(minROM)+4); ctx.fillText(`${maxROM}°`, 8, y(maxROM)+4);
      ctx.fillText(dates[0], x(0)-20, cv.height-12); ctx.fillText(dates[dates.length-1], x(dates.length-1)-36, cv.height-12);
      const ty = y(140); ctx.strokeStyle="#2dd4bf"; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(P.left,ty); ctx.lineTo(P.left+W,ty); ctx.stroke(); ctx.setLineDash([]); ctx.fillStyle="#a7f3d0"; ctx.fillText("Цель 140°", P.left+8, ty-6);
    }
    function renderLogList(){
      const el = document.getElementById("logList"); el.innerHTML="";
      const data = [...db.logs].sort((a,b)=>b.date.localeCompare(a.date));
      data.forEach(row=>{
        const it = document.createElement("div"); it.className="item";
        it.innerHTML = `<div><div style="font-weight:700">${row.date}</div>
          <div class="small muted">ROM: ${row.rom ?? "–"}° · Боль: ${row.pain ?? "–"} · Выполнено: ${row.completedIds?.length ?? 0}</div></div>
          <button class="btn small danger" data-date="${row.date}">Удалить</button>`;
        it.querySelector("button").addEventListener("click", ()=>{
          const idx = db.logs.findIndex(l=>l.date===row.date);
          if(idx>=0){ db.logs.splice(idx,1); persist(); drawChart(); renderLogList(); }
        });
        el.appendChild(it);
      });
    }
    document.getElementById("addRomBtn").addEventListener("click", ()=>{
      const rom = parseInt(prompt("Угол сгибания (в градусах):")); if(isNaN(rom)) return;
      const entry = { date: ISO(), pain: null, rom, completedIds: [] };
      const idx = db.logs.findIndex(l=>l.date===entry.date); if(idx>=0) db.logs[idx] = {...db.logs[idx], ...entry}; else db.logs.push(entry);
      persist(); drawChart(); renderLogList();
    });

    // Step-by-step
    function openStepByStep(){
      const m = todayModel(); const all = [...m.warmup, ...m.list, ...m.cooldown];
      if(!all.length){ alert("На сегодня нет упражнений"); return; }
      let idx = 0; const modal = document.createElement("div"); modal.className="modal";
      function render(){
        const ex = all[idx];
        modal.innerHTML = `<div class="card box">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0">${m.blockTitle}</h3><button class="btn ghost closeM">Закрыть</button></div>
          <div class="divider"></div>
          <div class="center" style="margin-bottom:10px">
            <div class="muted small">Шаг ${idx+1} из ${all.length}</div>
            <div style="font-size:22px; font-weight:800; margin-top:6px">${ex.name}</div>
            <div class="small muted" style="margin-top:6px">${ex.howTo}</div>
            <div class="row center" style="justify-content:center; margin-top:10px">
              ${ex.youtube ? `<a class="btn" href="${ex.youtube}" target="_blank" rel="noopener">Видео ▶</a>` : `<span class="small muted">без видео</span>`}
              <button class="btn ghost" id="timerBtn">Старт/Стоп таймер</button>
            </div>
            <div class="muted small" id="timerDisp" style="margin-top:6px">00:00</div>
          </div>
          <div class="divider"></div>
          <div class="row" style="justify-content:space-between">
            <button class="btn" id="prevBtn" ${idx===0?"disabled":""}>Назад</button>
            <div class="right">
              <label class="small" style="margin-right:8px"><input type="checkbox" id="markDone" ${isDone(ex.id)?"checked":""}/> выполнено</label>
              <button class="btn primary" id="nextBtn">${idx===all.length-1?"Завершить":"Дальше"}</button>
            </div>
          </div>
        </div>`;
        let running=false; let int=null;
        function fmt(s){const m=String(Math.floor(s/60)).padStart(2,"0"); const ss=String(s%60).padStart(2,"0"); return `${m}:${ss}`}
        modal.querySelector("#timerBtn").onclick = ()=>{
          if(!running){ running=true; const begin=Date.now(); int=setInterval(()=>{
            const sec = Math.floor((Date.now()-begin)/1000); modal.querySelector("#timerDisp").textContent = fmt(sec);
          }, 250); } else { running=false; clearInterval(int); int=null; }
        };
        modal.querySelector(".closeM").onclick = ()=>{ if(int) clearInterval(int); modal.remove(); };
        modal.querySelector("#prevBtn").onclick = ()=>{ if(int) clearInterval(int); idx=Math.max(0, idx-1); render(); };
        modal.querySelector("#nextBtn").onclick = ()=>{
          const ck = modal.querySelector("#markDone").checked;
          if(ck && !isDone(ex.id)) db.today.completed.push(ex.id);
          if(!ck){ const i=db.today.completed.indexOf(ex.id); if(i>=0) db.today.completed.splice(i,1); }
          persist();
          if(int) clearInterval(int);
          if(idx===all.length-1){ modal.remove(); renderToday(); alert("Тренировка завершена ✅"); } else { idx++; render(); }
        };
        modal.querySelector("#markDone").onchange = (e)=>{
          if(e.target.checked){ if(!isDone(ex.id)) db.today.completed.push(ex.id); } else {
            const i=db.today.completed.indexOf(ex.id); if(i>=0) db.today.completed.splice(i,1);
          }
          persist(); renderToday();
        };
      }
      render(); document.body.appendChild(modal);
    }
    document.getElementById("startBtn").addEventListener("click", openStepByStep);
  </script>
</body>
</html>
