<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>42 Fitness</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0f1115; --card:#161922; --muted:#8b93a7; --text:#f5f7fa;
      --accent:#34d399; --accent-2:#60a5fa; --danger:#ef4444; --ring:#243041; --border:#232838; --today:#1b2336;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, Arial;
      background:linear-gradient(180deg,#0d0f14, #0b1020); color:var(--text); line-height:1.5;
    }
    header{ position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background: rgba(13,16,26,.6); border-bottom:1px solid var(--border); padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.4px; }
    .logo{ width:34px; height:34px; border-radius:10px; background:#fff; color:#111; display:grid; place-items:center;
      font-weight:800; font-size:18px; box-shadow: 0 4px 24px rgba(255,255,255,.08);
    }
    .container{padding:16px; max-width:980px; margin:0 auto;}
    .grid{display:grid; gap:14px}
    .card{ background:linear-gradient(180deg, #151826, #111725); border:1px solid var(--border);
      border-radius:16px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .card h3{margin:0 0 10px 0; font-size:18px}
    .muted{color:var(--muted)} .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{ background:var(--card); color:var(--text); border:1px solid var(--border);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn.primary{ background:linear-gradient(180deg, #2b6cb0, #2563eb); border:0 }
    .btn.ghost{ background:transparent; border:1px solid var(--border) }
    .btn:active{ transform: translateY(1px) }
    .pill{border-radius:999px; padding:8px 12px; border:1px solid var(--border)}
    .list{display:grid; gap:10px}
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px;
      background:linear-gradient(180deg, #131828, #0f1422); border:1px solid var(--border);
    }
    .small{font-size:12px} .divider{height:1px; background:var(--border); margin:12px 0}
    .tabs{ position:fixed; bottom:0; left:0; right:0; z-index:20; background:rgba(10,12,20,.7); backdrop-filter: blur(8px);
      border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-around; padding:8px;
    }
    .tab{ text-align:center; color:#9aa3b8; font-size:12px; padding:6px 10px; border-radius:10px }
    .tab.active{ color:#fff; background:#151a28; border:1px solid var(--border) }
    main{ padding-bottom:70px }
    input[type="checkbox"]{ width:20px; height:20px; accent-color: var(--accent) }
    .tag{padding:4px 8px; border:1px solid var(--border); border-radius:8px; font-size:11px; color:#aab4ce}
    .calendar-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px; border:1px solid var(--border); }
    .calendar-row.today{ background: var(--today); }
    .badge{ font-size:11px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:#aab4ce}
    .status-done{ color:#34d399 } .status-cancel{ color:#ef4444 }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">42</div>
      <div>Fitness</div>
    </div>
    <div class="row">
      <button class="btn ghost small" id="exportBtn">Экспорт</button>
      <button class="btn ghost small" id="importBtn">Импорт</button>
      <input type="file" id="importFile" class="hidden" accept=".json" />
    </div>
  </header>

  <!-- VIEW: CALENDAR -->
  <main id="view-calendar" class="container">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <h3>Календарь недели</h3>
        <div class="row">
          <button class="btn" id="prevWeek">← Пред</button>
          <div class="pill" id="weekLabel">Неделя</div>
          <button class="btn" id="nextWeek">След →</button>
        </div>
      </div>
      <div class="small muted" id="todayHeader" style="margin:8px 0;">Сегодня: –</div>
      <div id="calendarList" class="list"></div>
      <div class="divider"></div>
      <div class="row">
        <div class="small muted">Подсказка: жми «Открыть» у дня, чтобы увидеть все упражнения и отмечать галочками.</div>
      </div>
    </section>
  </main>

  <!-- VIEW: DAY -->
  <main id="view-day" class="container hidden">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <h3 id="dayTitle">День</h3>
        <div class="row">
          <button class="btn ghost" id="backToCalendar">Назад</button>
          <button class="btn" id="cancelBtn">Отменить день</button>
          <button class="btn" id="uncancelBtn" style="display:none">Вернуть день</button>
        </div>
      </div>
      <div class="small muted" id="daySubtitle"></div>
      <div class="divider"></div>
      <div id="dayList" class="list"></div>
    </section>

    <section class="card">
      <h3>Журнал / ROM</h3>
      <div class="row">
        <div class="pill"><span class="muted small">Боль 0–10:</span> <input type="number" id="painInput" min="0" max="10" step="1" style="width:64px; margin-left:6px; background:#0d1220; color:#fff; border:1px solid var(--border); border-radius:10px; padding:8px"/></div>
        <div class="pill"><span class="muted small">Сгибание (°):</span> <input type="number" id="romInput" min="0" max="160" step="1" style="width:72px; margin-left:6px; background:#0d1220; color:#fff; border:1px solid var(--border); border-radius:10px; padding:8px"/></div>
        <button class="btn" id="saveQuickLog">Сохранить</button>
      </div>
    </section>
  </main>

  <!-- VIEW: LIBRARY -->
  <main id="view-library" class="container hidden">
    <section class="card">
      <h3>Библиотека упражнений</h3>
      <div class="row">
        <input id="searchInput" placeholder="Поиск по названию или тегу…" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0d1220; color:#fff" />
        <button class="btn" id="clearSearch">Очистить</button>
      </div>
      <div id="libraryList" class="list" style="margin-top:12px"></div>
    </section>
  </main>

  <!-- VIEW: PROGRESS -->
  <main id="view-progress" class="container hidden">
    <section class="card">
      <h3>Прогресс колена</h3>
      <canvas id="romChart" width="900" height="280" style="width:100%; border-radius:12px; background:#0d1220; border:1px solid var(--border)"></canvas>
      <div class="row" style="margin-top:10px">
        <div class="pill">Последний замер: <b id="lastROM">–</b>°</div>
        <div class="pill">Цель: <b>140</b>°</div>
      </div>
      <div class="divider"></div>
      <h3>Журнал</h3>
      <div id="logList" class="list"></div>
    </section>
  </main>

  <!-- VIEW: SETTINGS -->
  <main id="view-settings" class="container hidden">
    <section class="card">
      <h3>Настройки</h3>
      <div class="list">
        <div class="item"><div>Язык</div><div class="muted">Русский</div></div>
        <div class="item"><div>Тема</div><div class="muted">Тёмная</div></div>
        <div class="item"><div>О приложении</div><div class="muted">42 Fitness — календарь, чеклисты, ROM-график</div></div>
      </div>
    </section>
  </main>

  <nav class="tabs" role="tablist" aria-label="Навигация">
    <button class="tab active" data-view="calendar">Календарь</button>
    <button class="tab" data-view="library">Библиотека</button>
    <button class="tab" data-view="progress">Прогресс</button>
    <button class="tab" data-view="settings">Настройки</button>
  </nav>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
    }
  </script>

  <script>
    /************ DATA ************/
    const LS = { get:k=>JSON.parse(localStorage.getItem(k) || "null"), set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
    const EX = [
      { id:"patella-mob", name:"Двигать патель", tags:["разминка","ACL-safe","колено"], howTo:"Мягкая мобилизация надколенника 1–2 мин", youtube:null },
      { id:"bench-knee-flex", name:"Сгибание колена на скамейке", tags:["разминка","ACL-safe","колено"], howTo:"Мягко увеличиваем ROM 2–3 мин", youtube:null },
      { id:"kneeling-sit", name:"На коленях приседи (вбок/назад)", tags:["разминка","ACL-safe","колено"], howTo:"Контроль без боли 1–2 мин", youtube:null },
      { id:"bike", name:"Stationary Bike (8–12 мин)", tags:["разминка","бег","кардио"], howTo:"Низкое сопротивление", youtube:null },
      { id:"heel-slides", name:"Heel Slides", tags:["разминка","ACL-safe","колено"], howTo:"3×12 без боли", youtube:"https://www.youtube.com/watch?v=6-anByqnKp8" },
      { id:"squat-weight", name:"Squats with weight", tags:["зал","сила","колено"], howTo:"3–4×6–10, техника", youtube:"https://www.youtube.com/shorts/Ak1iHbEeeY8" },
      { id:"split-squat-bul", name:"Split Squat (Bulgarian)", tags:["зал","сила"], howTo:"3×8/нога", youtube:"https://www.youtube.com/shorts/_HukgYk7lTw" },
      { id:"bridges", name:"Hip Bridges", tags:["зал","ягодицы"], howTo:"3×12", youtube:"https://www.youtube.com/watch?v=Xp33YgPZgns" },
      { id:"hip-thrust", name:"Hip Thrusts", tags:["зал","ягодицы"], howTo:"3×10", youtube:"https://www.youtube.com/watch?v=pUdIL5x0fWg" },
      { id:"rdl", name:"Deadlifts (RDL)", tags:["зал","задняя цепь"], howTo:"3×8–10 лёгкий", youtube:"https://www.youtube.com/shorts/5rIqP63yWFg" },
      { id:"leg-press", name:"Leg Press", tags:["зал","колено"], howTo:"3×10, контроль амплитуды", youtube:"https://www.youtube.com/shorts/EotSw18oR9w" },
      { id:"calf-raises", name:"Calf Raises", tags:["зал","икры"], howTo:"3×15", youtube:"https://www.youtube.com/shorts/sNqa1ad2qIQ" },
      { id:"side-plank", name:"Side Plank (progression)", tags:["зал","кор"], howTo:"3×20–45 сек", youtube:"https://www.youtube.com/watch?v=kiVFaQAyZAE" },
      { id:"dead-bug", name:"Dead Bug", tags:["зал","кор"], howTo:"3×10/стор", youtube:"https://www.youtube.com/watch?v=jbWmbhElf3Q" },
      { id:"face-pull", name:"Face Pull (band)", tags:["зал","спина"], howTo:"3×12", youtube:"https://www.youtube.com/watch?v=0Po47vvj9g4" },
      { id:"step-ups", name:"Step-ups (низк/средн платформа)", tags:["зал","бег","баланс"], howTo:"3×8/нога", youtube:"https://www.youtube.com/shorts/AiP9Cv0gkl8" },
      { id:"lat-band-walk", name:"Lateral Band Walks", tags:["зал","баланс"], howTo:"3×10 шагов/стор", youtube:"https://www.youtube.com/shorts/HW9xLHrLhxI" },
      { id:"hop-balance", name:"Hop to Balance", tags:["зал","поле","динамика"], howTo:"3×6/направление", youtube:"https://www.youtube.com/shorts/oxi3hc_Kqe8" },
      { id:"ladder", name:"Agility Ladder", tags:["зал","поле","координация"], howTo:"3–5 паттернов", youtube:"https://www.youtube.com/shorts/p3K2u1bVsR0" },
      { id:"skater", name:"Skater Jumps", tags:["зал","поле","динамика"], howTo:"3×8/стор", youtube:"https://www.youtube.com/shorts/el_HLUDDYJs" },
      { id:"shuttle", name:"Shuttle Runs", tags:["поле","скорость"], howTo:"короткие ускорения/торможения", youtube:"https://www.youtube.com/results?search_query=Shuttle+Runs" },
      { id:"cone", name:"Cone Drills", tags:["поле","координация"], howTo:"змейка/повороты", youtube:"https://www.youtube.com/shorts/SYsoujNU34Q" },
      { id:"dyn-ham", name:"Dynamic Hamstring Stretch", tags:["заминка","мобилити"], howTo:"2×30–45 сек", youtube:"https://www.youtube.com/watch?v=GBmrncZApes" },
      { id:"calf-stretch", name:"Calf Stretch", tags:["заминка","мобилити"], howTo:"2×30 сек", youtube:"https://www.youtube.com/watch?v=mafo7o7OnFo" },
    ];

    // Week templates A/B (Mon..Sun as 1..0)
    const WEEK_A = {
      1:{ title:"Зал — сила+баланс", type:"gym", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["squat-weight","split-squat-bul","bridges","hip-thrust","rdl","leg-press","calf-raises","side-plank","dead-bug","face-pull","step-ups","lat-band-walk","hop-balance","ladder","skater"],
          cooldown:["dyn-ham","calf-stretch"] },
      2:{ title:"Бег/кардио + ROM", type:"run", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["step-ups","hop-balance","dyn-ham","ladder"], cooldown:["calf-stretch"] },
      3:{ title:"Зал — сила+баланс", type:"gym", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["squat-weight","split-squat-bul","bridges","hip-thrust","rdl","leg-press","calf-raises","side-plank","dead-bug","face-pull","step-ups","lat-band-walk","hop-balance","ladder","skater"],
          cooldown:["dyn-ham","calf-stretch"] },
      4:{ title:"Бег/кардио + ROM", type:"run", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["step-ups","hop-balance","dyn-ham","ladder"], cooldown:["calf-stretch"] },
      5:{ title:"Зал — сила+баланс", type:"gym", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["squat-weight","split-squat-bul","bridges","hip-thrust","rdl","leg-press","calf-raises","side-plank","dead-bug","face-pull","step-ups","lat-band-walk","hop-balance","ladder","skater"],
          cooldown:["dyn-ham","calf-stretch"] },
      6:{ title:"Поле — динамика/футбол", type:"field", warmup:["patella-mob","bench-knee-flex","kneeling-sit","heel-slides"],
          list:["shuttle","cone","skater","hop-balance","ladder"], cooldown:["dyn-ham","calf-stretch"] },
      0:{ title:"Отдых/мобилити", type:"rest", warmup:["patella-mob","bench-knee-flex","kneeling-sit"], list:[], cooldown:[] }
    };
    const WEEK_B = {
      1: WEEK_A[1],
      2:{ title:"Поле — динамика/футбол", type:"field", warmup:["patella-mob","bench-knee-flex","kneeling-sit","heel-slides"],
          list:["shuttle","cone","skater","hop-balance","ladder"], cooldown:["dyn-ham","calf-stretch"] },
      3: WEEK_A[3],
      4:{ title:"Поле — динамика/футбол", type:"field", warmup:["patella-mob","bench-knee-flex","kneeling-sit","heel-slides"],
          list:["shuttle","cone","skater","hop-balance","ladder"], cooldown:["dyn-ham","calf-stretch"] },
      5: WEEK_A[5],
      6:{ title:"Бег/кардио + ROM", type:"run", warmup:["patella-mob","bench-knee-flex","kneeling-sit","bike","heel-slides"],
          list:["step-ups","hop-balance","dyn-ham","ladder"], cooldown:["calf-stretch"] },
      0: WEEK_A[0]
    };

    const db = {
      exercises: LS.get("exercises") ?? EX,
      logs: LS.get("logs") ?? [],
      canceled: LS.get("canceled") ?? [], // ISO dates
    };
    function persist(){ LS.set("exercises", db.exercises); LS.set("logs", db.logs); LS.set("canceled", db.canceled); }

    /************ HELPERS ************/
    const DOW_LABEL = ["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];
    const TYPE_LABEL = { gym:"Зал", run:"Бег", field:"Поле", rest:"Отдых" };
    function ISO(d){ return d.toISOString().slice(0,10); }
    function startOfWeek(date){ // Monday-start
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = (d.getDay()+6)%7; // 0..6 with Monday=0
      d.setUTCDate(d.getUTCDate()-day);
      return d;
    }
    function addDays(d, n){ const c=new Date(d); c.setUTCDate(c.getUTCDate()+n); return c; }
    function isoWeekNumber(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }
    function weekTemplateByDate(date){
      const wk = isoWeekNumber(date);
      return (wk % 2 === 1) ? WEEK_A : WEEK_B; // odd -> A, even -> B
    }
    function exById(id){ return db.exercises.find(e=>e.id===id) }

    /************ NAV ************/
    const views = {
      calendar: document.getElementById("view-calendar"),
      day: document.getElementById("view-day"),
      library: document.getElementById("view-library"),
      progress: document.getElementById("view-progress"),
      settings: document.getElementById("view-settings")
    };
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(t=> t.addEventListener("click", ()=>switchView(t.dataset.view)));
    function switchView(v){
      Object.values(views).forEach(x=>x.classList.add("hidden"));
      views[v].classList.remove("hidden");
      tabs.forEach(t=>t.classList.toggle("active", t.dataset.view===v));
      if(v==="calendar") renderCalendar();
      if(v==="library") renderLibrary();
      if(v==="progress") { drawChart(); renderLogList(); }
    }

    /************ CALENDAR ************/
    let weekOffset = 0; // 0= this week, -1 prev, +1 next
    document.getElementById("prevWeek").addEventListener("click", ()=>{ weekOffset--; renderCalendar(); });
    document.getElementById("nextWeek").addEventListener("click", ()=>{ weekOffset++; renderCalendar(); });

    function renderCalendar(){
      const today = new Date();
      const base = startOfWeek(new Date(today.getFullYear(), today.getMonth(), today.getDate()));
      const showing = addDays(base, weekOffset*7);
      const tpl = weekTemplateByDate(showing);

      const weekNum = isoWeekNumber(showing);
      document.getElementById("weekLabel").textContent = `Неделя ${weekNum}`;

      // Today header
      const tTpl = weekTemplateByDate(today);
      const tDow = today.getDay();
      const tPlan = tTpl[tDow];
      document.getElementById("todayHeader").textContent =
        `Сегодня: ${DOW_LABEL[tDow]} — ${TYPE_LABEL[tPlan.type]} (${tPlan.title})`;

      const list = document.getElementById("calendarList"); list.innerHTML="";
      for(let i=0;i<7;i++){
        const date = addDays(showing, i);
        const iso = ISO(date);
        const dow = date.getDay();
        const p = tpl[dow];
        const canceled = db.canceled.includes(iso);
        const dayLogs = db.logs.find(l=>l.date===iso);
        const doneCount = dayLogs?.completedIds?.length || 0;
        const total = (p.warmup.length + p.list.length + p.cooldown.length);
        const done = total>0 && doneCount>=total;

        const row = document.createElement("div");
        row.className = "calendar-row" + (weekOffset===0 && iso===ISO(today) ? " today": "");
        row.innerHTML = `<div>
          <div style="font-weight:700">${DOW_LABEL[dow]} — ${TYPE_LABEL[p.type]}</div>
          <div class="small muted">${iso} · ${p.title}</div>
        </div>
        <div class="row">
          ${canceled ? `<span class="badge status-cancel">Отменено</span>` : done ? `<span class="badge status-done">Выполнено</span>` : `<span class="badge">Запланировано</span>`}
          <button class="btn small open">Открыть</button>
        </div>`;
        row.querySelector(".open").addEventListener("click", ()=> openDay(iso));
        list.appendChild(row);
      }
    }

    /************ DAY VIEW ************/
    let currentDayISO = null;
    function openDay(iso){
      currentDayISO = iso;
      switchView("day");
      const d = new Date(iso + "T00:00:00");
      const tpl = weekTemplateByDate(d);
      const p = tpl[d.getDay()];

      document.getElementById("dayTitle").textContent = `${iso} — ${TYPE_LABEL[p.type]}`;
      document.getElementById("daySubtitle").textContent = p.title;

      const isToday = (iso === ISO(new Date()));
      document.getElementById("cancelBtn").style.display = isToday && !db.canceled.includes(iso) ? "inline-block" : "none";
      document.getElementById("uncancelBtn").style.display = isToday && db.canceled.includes(iso) ? "inline-block" : "none";

      const list = document.getElementById("dayList"); list.innerHTML="";
      const seq = [...p.warmup.map(id=>({id, block:"Разминка"})),
                   ...p.list.map(id=>({id, block:"Основные"})),
                   ...p.cooldown.map(id=>({id, block:"Заминка"}))];

      const log = db.logs.find(l=>l.date===iso) || { date: iso, pain:null, rom:null, completedIds: [] };
      if(!db.logs.find(l=>l.date===iso)){ db.logs.push(log); persist(); }

      let lastBlock = null;
      seq.forEach((row, idx)=>{
        const ex = exById(row.id);
        if(!ex) return;
        if(row.block !== lastBlock){
          const h = document.createElement("div"); h.className="muted"; h.style.margin="6px 4px"; h.textContent = row.block;
          list.appendChild(h); lastBlock = row.block;
        }
        const item = document.createElement("div"); item.className="item";
        const checked = log.completedIds.includes(row.id);
        item.innerHTML = `<div style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" ${checked?"checked":""} />
            <div>
              <div style="font-weight:700">${ex.name}</div>
              <div class="small muted">${ex.howTo}</div>
              <div class="row small">
                ${ex.tags.slice(0,3).map(t=>`<span class="tag">${t}</span>`).join(" ")}
                ${ex.youtube ? `<a class="btn small" href="${ex.youtube}" target="_blank" rel="noopener">Видео ▶</a>` : `<span class="small muted">без видео</span>`}
              </div>
            </div>
          </div>`;
        const cb = item.querySelector("input[type=checkbox]");
        cb.addEventListener("change", ()=>{
          const i = log.completedIds.indexOf(row.id);
          if(cb.checked && i<0) log.completedIds.push(row.id);
          if(!cb.checked && i>=0) log.completedIds.splice(i,1);
          persist(); // update log
        });
        list.appendChild(item);
      });

      // Quick log buttons attach to this day
      document.getElementById("saveQuickLog").onclick = ()=>{
        const rom = parseInt(document.getElementById("romInput").value || ""); 
        const pain = parseInt(document.getElementById("painInput").value || ""); 
        log.rom = isNaN(rom) ? log.rom : rom;
        log.pain = isNaN(pain) ? log.pain : pain;
        persist();
        alert("Сохранено ✅");
        document.getElementById("romInput").value=""; 
        document.getElementById("painInput").value="";
      };
    }
    document.getElementById("backToCalendar").addEventListener("click", ()=>{ switchView("calendar"); renderCalendar(); });

    // Cancel / Uncancel today
    document.getElementById("cancelBtn").addEventListener("click", ()=>{
      if(!currentDayISO) return;
      if(confirm("Отменить сегодняшний день?")){
        if(!db.canceled.includes(currentDayISO)) db.canceled.push(currentDayISO);
        persist(); openDay(currentDayISO);
      }
    });
    document.getElementById("uncancelBtn").addEventListener("click", ()=>{
      if(!currentDayISO) return;
      const idx = db.canceled.indexOf(currentDayISO);
      if(idx>=0) db.canceled.splice(idx,1);
      persist(); openDay(currentDayISO);
    });

    /************ LIBRARY ************/
    function renderLibrary(){
      const el = document.getElementById("libraryList");
      const q = (document.getElementById("searchInput").value||"").toLowerCase();
      el.innerHTML="";
      db.exercises.filter(ex=> ex.name.toLowerCase().includes(q) || ex.tags.some(t=>t.toLowerCase().includes(q))).forEach(ex=>{
        const item = document.createElement("div"); item.className="item";
        item.innerHTML = `<div>
            <div style="font-weight:800">${ex.name}</div>
            <div class="small muted">ID: ${ex.id}</div>
            <div class="small muted" style="margin-top:4px">${ex.howTo}</div>
            <div class="row small" style="margin-top:6px">${ex.tags.map(t=>`<span class="tag">${t}</span>`).join(" ")}</div>
          </div>
          <div class="row">${ex.youtube ? `<a class="btn small" href="${ex.youtube}" target="_blank" rel="noopener">Видео ▶</a>` : `<span class="small muted">без видео</span>`}</div>`;
        el.appendChild(item);
      });
    }
    document.getElementById("searchInput").addEventListener("input", renderLibrary);
    document.getElementById("clearSearch").addEventListener("click", ()=>{ document.getElementById("searchInput").value=""; renderLibrary(); });

    /************ PROGRESS ************/
    function drawChart(){
      const cv = document.getElementById("romChart"); const ctx = cv.getContext("2d");
      ctx.clearRect(0,0,cv.width,cv.height);
      const P = { left:50, right:20, top:20, bottom:40 }; const W = cv.width - P.left - P.right; const H = cv.height - P.top - P.bottom;
      ctx.strokeStyle = "#2a3348"; ctx.strokeRect(P.left, P.top, W, H);
      for(let i=0;i<=5;i++){ const y=P.top+(H/5)*i; ctx.beginPath(); ctx.moveTo(P.left,y); ctx.lineTo(P.left+W,y); ctx.strokeStyle="#1f2a40"; ctx.stroke(); }
      const data = [...(db.logs||[])].filter(l=>typeof l.rom==="number").sort((a,b)=>a.date.localeCompare(b.date));
      const roms = data.map(d=>d.rom); const dates = data.map(d=>d.date);
      document.getElementById("lastROM").textContent = roms.length ? roms[roms.length-1] : "–"; if(!data.length) return;
      const minROM = Math.min(90, Math.min(...roms)); const maxROM = Math.max(140, Math.max(...roms));
      const x=i=> P.left + (W/(data.length-1||1))*i; const y=v=> P.top + H - ((v-minROM)/(maxROM-minROM||1))*H;
      ctx.beginPath(); data.forEach((d,i)=>{ if(i===0) ctx.moveTo(x(i),y(d.rom)); else ctx.lineTo(x(i),y(d.rom)); }); ctx.strokeStyle="#60a5fa"; ctx.lineWidth=2; ctx.stroke();
      ctx.fillStyle="#34d399"; data.forEach((d,i)=>{ ctx.beginPath(); ctx.arc(x(i),y(d.rom),3,0,Math.PI*2); ctx.fill(); });
      ctx.fillStyle="#9aa3b8"; ctx.font="12px system-ui"; ctx.fillText(`${minROM}°`, 8, y(minROM)+4); ctx.fillText(`${maxROM}°`, 8, y(maxROM)+4);
      ctx.fillText(dates[0], x(0)-20, cv.height-12); ctx.fillText(dates[dates.length-1], x(dates.length-1)-36, cv.height-12);
      const ty = y(140); ctx.strokeStyle="#2dd4bf"; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(P.left,ty); ctx.lineTo(P.left+W,ty); ctx.stroke(); ctx.setLineDash([]); ctx.fillStyle="#a7f3d0"; ctx.fillText("Цель 140°", P.left+8, ty-6);
    }
    function renderLogList(){
      const el = document.getElementById("logList"); el.innerHTML="";
      const data = [...(db.logs||[])].sort((a,b)=>b.date.localeCompare(a.date));
      data.forEach(row=>{
        const it = document.createElement("div"); it.className="item";
        it.innerHTML = `<div><div style="font-weight:700">${row.date}</div>
          <div class="small muted">ROM: ${row.rom ?? "–"}° · Боль: ${row.pain ?? "–"} · Выполнено: ${row.completedIds?.length ?? 0}</div></div>`;
        el.appendChild(it);
      });
    }

    /************ IMPORT/EXPORT ************/
    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `42-fitness-data-${ISO(new Date())}.json`; a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
    document.getElementById("importFile").addEventListener("change", async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      try{ const text = await file.text(); const obj = JSON.parse(text);
        if(obj.exercises && obj.logs && obj.canceled){
          db.exercises = obj.exercises; db.logs = obj.logs; db.canceled = obj.canceled; persist();
          alert("Импортировано ✅"); renderCalendar(); drawChart(); renderLogList();
        } else { alert("Файл не похож на экспорт 42 Fitness v3")}
      }catch(err){ alert("Ошибка импорта: " + err.message); } finally { e.target.value = "" }
    });

    // init
    renderCalendar();
  </script>
</body>
</html>
